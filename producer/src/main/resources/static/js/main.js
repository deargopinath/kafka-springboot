token = "unknown"

$(document).ready(
    function () {
        $("#overpayment-form").submit(
            function (event) {
                event.preventDefault()
                singleSignOn(true)
            }
        )
    
        $("#get-token-form").submit(
            function (event) {
                event.preventDefault()
                singleSignOn(false)
            }
        )
    }
)

function singleSignOn(openOPI) {
    var input = {}

    input["product"] = $("#product").val()
    var franchise = "other"
    if (document.getElementById("isFranchised").checked) {
        franchise = "retail"
    }
    input["franchise"] = franchise
    
    console.log("Product: " + input["product"] + "-" + input["franchise"])
    
    $("#overpayment-button").prop("disabled", true)

    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: "/api/jwe",
        data: JSON.stringify(input),
        dataType: 'json',
        cache: false,
        timeout: 600000,
        success: function (output) {
            token = output["token"]
            console.log("SUCCESS : Token was generated by IB")
            console.log(JSON.stringify(output))
            document.getElementById("token").value = token            
            if(openOPI) {
                console.log("Attempting to login with token...")
                $.ajax({
                    url: clientURL,
                    type: 'get',
                    contentType: 'text/html',
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    success: () => {window.open(clientURL, "_self")}
                })            	
            }
        },
        error: function (e) {
            var json = "Error received from server: " + e.responseText
            console.log("ERROR : ", e.responseText)
        }
    })
    $("#overpayment-button").prop("disabled", false)
}
